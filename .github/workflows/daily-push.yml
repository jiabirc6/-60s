name: Daily WeChat Image Push

on:
  schedule:
    - cron: '0 3 * * *'  # UTC 3:00 = 北京 11:00，用 crontab.guru 测试调整
  workflow_dispatch:  # 手动测试

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Download Image
        run: |
          curl -L -f "https://60s.190009.xyz/v2/60s?encoding=image" -o daily_news.png
          if [ ! -f daily_news.png ] || [ ! -s daily_news.png ]; then
            echo "❌ Download failed: File missing or empty"
            exit 1
          fi
          echo "✅ Image downloaded: $(file daily_news.png)"
          ls -la daily_news.png  # 显示文件大小（应 ~1-5MB）

      - name: Upload Artifact for Debug
        uses: actions/upload-artifact@v4
        with:
          name: daily-news-image
          path: daily_news.png
        if: always()  # 失败时也上传，便于检查你的 API

      - name: Send to WeChat via PushPlus API
        if: success()  # 只在下载成功时推送
        run: |
          # 图片转 base64（无换行，便于嵌入）
          BASE64_IMG=$(base64 -w 0 daily_news.png)
          # POST 到 PushPlus API（HTML 模板内嵌图片）
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"token\":\"${{ secrets.PPTOKEN }}\",\"title\":\"今日 60s 新闻摘要\",\"template\":\"html\",\"content\":\"<h3>每天 60 秒看世界！</h3><img src='data:image/png;base64,$BASE64_IMG' style='max-width:100%; height:auto; border:1px solid #ccc;' /><p>（点击查看大图）</p>\"}" \
            https://www.pushplus.plus/send)
          echo "$RESPONSE"  # 输出响应，便于日志调试
          if echo "$RESPONSE" | grep -q '"code":"200"'; then
            echo "✅ Push successful!"
          else
            echo "❌ Push failed: $RESPONSE"
            exit 1
          fi
